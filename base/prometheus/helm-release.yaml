# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/all.json

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: prometheus
spec:
  releaseName: prometheus
  interval: 1m
  chart:
    spec:
      chart: prometheus
      version: 27.*
      sourceRef:
        kind: HelmRepository
        name: prometheus
        namespace: monitoring
  values:
    serverFiles:
      prometheus.yml:
        scrape_configs:
          - job_name: opentelemetry-collector
            static_configs:
              - targets:
                  - opentelemetry-collector.monitoring.svc.cluster.local:8888
    server:
      tsdb:
        # https://prometheus.io/docs/guides/opentelemetry/#enable-out-of-order-ingestion
        out_of_order_time_window: 10m
      # https://prometheus.io/docs/guides/opentelemetry
      otlp:
        translation_strategy: NoUTF8EscapingWithSuffixes
        promote_resource_attributes:
          - service.instance.id
          - service.name
          - service.namespace
          - service.version
          - cloud.availability_zone
          - cloud.region
          - container.name
          - deployment.environment
          - deployment.environment.name
          - k8s.cluster.name
          - k8s.container.name
          - k8s.cronjob.name
          - k8s.daemonset.name
          - k8s.deployment.name
          - k8s.job.name
          - k8s.namespace.name
          - k8s.pod.name
          - k8s.replicaset.name
          - k8s.statefulset.name
